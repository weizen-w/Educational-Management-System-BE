<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.8.xsd">

  <changeSet id="create-users-table" author="Wladimir">
    <createTable tableName="users">
      <column name="user_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="username" type="varchar(100)">
        <constraints unique="true" nullable="false"/>
      </column>
      <column name="password" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <column name="first_name" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <column name="last_name" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="varchar(150)">
        <constraints unique="true" nullable="false"/>
      </column>
      <column name="role_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="group_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="is_blocked" type="bool">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-roles-table" author="Wladimir">
    <createTable tableName="roles">
      <column name="role_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="role_name" type="varchar(100)">
        <constraints unique="true" nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-courses-table" author="Wladimir">
    <createTable tableName="courses">
      <column name="course_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="course_name" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <column name="is_archived" type="bool">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-student-groups-table" author="Wladimir">
    <createTable tableName="student_groups">
      <column name="group_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="group_name" type="varchar(150)">
        <constraints nullable="false"/>
      </column>
      <column name="course_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="is_archived" type="bool">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-lectures-table" author="Wladimir">
    <createTable tableName="lectures">
      <column name="lecture_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="course_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="lecture_title" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <column name="lecture_description" type="text"/>
      <column name="lecturer_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="lecture_date" type="date">
        <constraints nullable="false"/>
      </column>
      <column name="start_time" type="time">
        <constraints nullable="false"/>
      </column>
      <column name="end_time" type="time">
        <constraints nullable="false"/>
      </column>
      <column name="module_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="is_archived" type="bool">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-attendances-table" author="Wladimir">
    <createTable tableName="attendances">
      <column name="attendance_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="student_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="lecture_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="attendance_date" type="date">
        <constraints nullable="false"/>
      </column>
      <column name="status_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="is_archived" type="bool">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-attendance-statuses-table" author="Wladimir">
    <createTable tableName="attendance_statuses">
      <column name="status_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="status_name" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-observers-table" author="Wladimir">
    <createTable tableName="observers">
      <column name="observer_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="student_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="observed_group_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-schedules-table" author="Wladimir">
    <createTable tableName="schedules">
      <column name="schedule_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="lecture_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="group_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="lecture_date" type="date">
        <constraints nullable="false"/>
      </column>
      <column name="start_time" type="timestamp">
        <constraints nullable="false"/>
      </column>
      <column name="end_time" type="timestamp">
        <constraints nullable="false"/>
      </column>
      <column name="is_archived" type="bool">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="create-modules-table" author="Wladimir">
    <createTable tableName="modules">
      <column name="module_id" type="bigserial">
        <constraints primaryKey="true"/>
      </column>
      <column name="module_name" type="varchar(100)">
        <constraints nullable="false"/>
      </column>
      <column name="is_archived" type="bool">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="add-foreign-keys" author="Wladimir">
    <addForeignKeyConstraint baseTableName="users" baseColumnNames="role_id"
      referencedTableName="roles" referencedColumnNames="role_id"
      constraintName="FK_users_roles"/>
    <addForeignKeyConstraint baseTableName="users" baseColumnNames="group_id"
      referencedTableName="student_groups" referencedColumnNames="group_id"
      constraintName="FK_users_student_groups"/>
    <addForeignKeyConstraint baseTableName="observers" baseColumnNames="student_id"
      referencedTableName="users" referencedColumnNames="user_id"
      constraintName="FK_observers_users"/>
    <addForeignKeyConstraint baseTableName="attendances" baseColumnNames="student_id"
      referencedTableName="users" referencedColumnNames="user_id"
      constraintName="FK_attendances_users"/>
    <addForeignKeyConstraint baseTableName="attendances" baseColumnNames="lecture_id"
      referencedTableName="lectures" referencedColumnNames="lecture_id"
      constraintName="FK_attendances_lectures"/>
    <addForeignKeyConstraint baseTableName="attendances" baseColumnNames="status_id"
      referencedTableName="attendance_statuses" referencedColumnNames="status_id"
      constraintName="FK_attendances_statuses"/>
    <addForeignKeyConstraint baseTableName="lectures" baseColumnNames="course_id"
      referencedTableName="courses" referencedColumnNames="course_id"
      constraintName="FK_lectures_courses"/>
    <addForeignKeyConstraint baseTableName="student_groups" baseColumnNames="course_id"
      referencedTableName="courses" referencedColumnNames="course_id"
      constraintName="FK_student_groups_courses"/>
    <addForeignKeyConstraint baseTableName="observers" baseColumnNames="observed_group_id"
      referencedTableName="student_groups" referencedColumnNames="group_id"
      constraintName="FK_observers_student_groups"/>
    <addForeignKeyConstraint baseTableName="lectures" baseColumnNames="lecturer_id"
      referencedTableName="users" referencedColumnNames="user_id"
      constraintName="FK_lectures_users"/>
    <addForeignKeyConstraint baseTableName="schedules" baseColumnNames="group_id"
      referencedTableName="student_groups" referencedColumnNames="group_id"
      constraintName="FK_schedules_student_groups"/>
    <addForeignKeyConstraint baseTableName="schedules" baseColumnNames="lecture_id"
      referencedTableName="lectures" referencedColumnNames="lecture_id"
      constraintName="FK_schedules_lectures"/>
    <addForeignKeyConstraint baseTableName="lectures" baseColumnNames="module_id"
      referencedTableName="modules" referencedColumnNames="module_id"
      constraintName="FK_lectures_modules"/>
  </changeSet>

  <changeSet id="adding-data-to-DB" author="Wladimir">
    <loadData
      tableName="courses"
      file="db/data/courses.csv">
    </loadData>
    <loadData
      tableName="student_groups"
      file="db/data/student_groups.csv">
    </loadData>
  </changeSet>

</databaseChangeLog>
